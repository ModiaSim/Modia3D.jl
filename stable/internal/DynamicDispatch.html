<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Dynamic Dispatch · Modia3D</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../index.html">Modia3D</a></span></div><form class="docs-search" action="../search.html"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../index.html">Home</a></li><li><span class="tocitem">Tutorial</span><ul><li><a class="tocitem" href="../tutorial/Tutorial.html">Modia3D Tutorial</a></li><li><a class="tocitem" href="../tutorial/GettingStarted.html">Getting Started</a></li><li><a class="tocitem" href="../tutorial/HierarchicalModels.html">Hierarchical models</a></li><li><a class="tocitem" href="../tutorial/RecursiveModels.html">Recursive models</a></li><li><a class="tocitem" href="../tutorial/CollisionHandling.html">Collision Handling</a></li></ul></li><li><span class="tocitem">Components</span><ul><li><a class="tocitem" href="../Components/Object3D.html">Object3D</a></li><li><a class="tocitem" href="../Components/Shapes.html">Shapes</a></li><li><a class="tocitem" href="../Components/Joints.html">Joints</a></li><li><a class="tocitem" href="../Components/Materials.html">Materials</a></li><li><a class="tocitem" href="../Components/GravityField.html">Gravity Field</a></li><li><a class="tocitem" href="../Components/ForceElements.html">Force Elements</a></li></ul></li><li><span class="tocitem">Internal</span><ul><li><a class="tocitem" href="Profiling.html">Profiling</a></li><li class="is-active"><a class="tocitem" href="DynamicDispatch.html">Dynamic Dispatch</a></li><li><a class="tocitem" href="ContactDetection.html">Contact Detection</a></li><li><a class="tocitem" href="ContactForceLaw.html">Contact Force Law</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Internal</a></li><li class="is-active"><a href="DynamicDispatch.html">Dynamic Dispatch</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="DynamicDispatch.html">Dynamic Dispatch</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/ModiaSim/Modia3D.jl/blob/master/docs/src/internal/DynamicDispatch.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Dynamic-Dispatch"><a class="docs-heading-anchor" href="#Dynamic-Dispatch">Dynamic Dispatch</a><a id="Dynamic-Dispatch-1"></a><a class="docs-heading-anchor-permalink" href="#Dynamic-Dispatch" title="Permalink"></a></h1><p>Modia3D uses several abstract types in structs in order to store information about different types of joints, shapes, collision response laws etc. Several functions are used to operate on these types. A direct implementation would lead to <strong>dynamic dispatch</strong>, so the functions to be called and the types to be operated on, would be determined at run-time (and not at compile time). This leads to slow simulation and a lot of memory allocation during simulation.</p><p>In this <a href="https://groups.google.com/forum/#!msg/julia-users/jUMu9A3QKQQ/qjgVWr7vAwAJ">forum discussion</a> a similar issue is discussed for a tiny use case and three solutions are compared: (1) dynamic dispatch, (2) dictionary lookup, and (3) if-clauses. In this simple example version (3) is about a factor of <strong>15 faster</strong> as (1) and allocates 200 bytes, whereas (1) allocates 1.5 Mbyte.</p><p>In the rest of this section the technique is sketched that is used in Modia3D to avoid (a) dynamic dispatch and (b) access of abstract types <em>during simulation</em>:</p><p>The <strong>Object3D</strong> struct holds all information about an Object3D object:</p><pre><code class="language-julia hljs">@enum JointKind FixKind RevoluteKind PrismaticKind ...
@enum ShapeKind NoShapeKind SphereKind BoxKind CylinderKind ...

mutable struct Object3D
    ...
    # Relative motion parent/Object3D
    joint::AbstractJoint               # ::Fix, ::Revolute, ...

    # Efficient access of joint properties
    jointKind::JointKind               # Kind of joint
    ndof::Int                          # Number of degrees of freedom
    canCollide::Bool                   # = false, if no collision parent/Object3D

    # Feature associated with Object3D
    feature::AbstractObject3DFeature   # ::EmptyObject3DFeature ::Scene, ::Visual, ::Solid

    # Efficient access of feature properties
    shapeKind::Shapes.ShapeKind        # Kind of shape
    shape::Modia3D.AbstractShape
    visualMaterial::Shapes.VisualMaterial
    ...
end</code></pre><p>In particular it holds <em>abstract types</em> for the <code>joint</code> and the <code>feature</code> associated with the <code>Object3D</code>. During initialization, the properties of <code>joint</code> and <code>feature</code> are copied to storage locations that have a <em>concrete type</em>. </p><p>All operations on the abstract types are implemented with <em>if-clauses</em> and only access <em>concrete types</em>. For example, <em>Support points</em> needed to determine the shortest distances between colliding <code>Object3D</code>&#39;s are computed with:</p><pre><code class="language-julia hljs">function supportPoint(obj::Object3D, e::SVector{3,Float64})::SVector{3,Float64}
    shapeKind                = obj.shapeKind   # type Int
    solid::Modia3D.Solid     = obj.feature
    collisionSmoothingRadius = solid.collisionSmoothingRadius  # type Float64

    if shapeKind == Modia3D.SphereKind
        return supportPoint_Sphere(obj.shape, obj.r_abs, obj.R_abs, e)
    elseif shapeKind == Modia3D.EllipsoidKind
        return supportPoint_Ellipsoid(obj.shape, obj.r_abs, obj.R_abs, e)
    elseif shapeKind == Modia3D.BoxKind
        return supportPoint_Box(obj.shape, obj.r_abs, obj.R_abs, e, collisionSmoothingRadius)
    ...
    end
end</code></pre><p>Note, a function such as <code>supportPoint_Sphere(..)</code> requires that its first argument is an instance of the concrete type <code>Sphere</code>. Due to the if-clause, this is guaranteed. Julia will just make a cheap run-time check that this requirement is fulfilled. The concrete function (<code>supportPoint_Sphere</code>) is translated when llvm code is generated.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="Profiling.html">« Profiling</a><a class="docs-footer-nextpage" href="ContactDetection.html">Contact Detection »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.13 on <span class="colophon-date" title="Tuesday 1 March 2022 19:59">Tuesday 1 March 2022</span>. Using Julia version 1.7.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
