<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Profiling · Modia3D</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../index.html">Modia3D</a></span></div><form class="docs-search" action="../search.html"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../index.html">Home</a></li><li><span class="tocitem">Tutorial</span><ul><li><a class="tocitem" href="../tutorial/Tutorial.html">Modia3D Tutorial</a></li><li><a class="tocitem" href="../tutorial/GettingStarted.html">Getting Started</a></li><li><a class="tocitem" href="../tutorial/HierarchicalModels.html">Hierarchical models</a></li><li><a class="tocitem" href="../tutorial/RecursiveModels.html">Recursive models</a></li><li><a class="tocitem" href="../tutorial/CollisionHandling.html">Collision Handling</a></li></ul></li><li><span class="tocitem">Components</span><ul><li><a class="tocitem" href="../Components/Object3D.html">Object3D</a></li><li><a class="tocitem" href="../Components/Shapes.html">Shapes</a></li><li><a class="tocitem" href="../Components/Joints.html">Joints</a></li><li><a class="tocitem" href="../Components/Materials.html">Materials</a></li><li><a class="tocitem" href="../Components/GravityField.html">Gravity Field</a></li><li><a class="tocitem" href="../Components/ForceElements.html">Force Elements</a></li></ul></li><li><span class="tocitem">Internal</span><ul><li class="is-active"><a class="tocitem" href="Profiling.html">Profiling</a><ul class="internal"><li><a class="tocitem" href="#@time"><span>@time</span></a></li><li><a class="tocitem" href="#logTiming"><span>logTiming</span></a></li></ul></li><li><a class="tocitem" href="DynamicDispatch.html">Dynamic Dispatch</a></li><li><a class="tocitem" href="ContactDetection.html">Contact Detection</a></li><li><a class="tocitem" href="ContactForceLaw.html">Contact Force Law</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Internal</a></li><li class="is-active"><a href="Profiling.html">Profiling</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="Profiling.html">Profiling</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/ModiaSim/Modia3D.jl/blob/master/docs/src/internal/Profiling.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Profiling"><a class="docs-heading-anchor" href="#Profiling">Profiling</a><a id="Profiling-1"></a><a class="docs-heading-anchor-permalink" href="#Profiling" title="Permalink"></a></h1><p>This section summarizes some techniques to determine timing and memory allocation measures for Modia3D. The various approaches are demonstrated with models from directory <code>Modia3D/test/Profiling</code>.</p><h2 id="@time"><a class="docs-heading-anchor" href="#@time">@time</a><a id="@time-1"></a><a class="docs-heading-anchor-permalink" href="#@time" title="Permalink"></a></h2><p>The simplest technique is to put <code>@time</code> in front of the statement that should be measured, such as:</p><pre><code class="language-julia hljs"># File Modia3D/test/Profiling/BouncingSphere_time.jl

module BouncingSphereSimulation_time

@time begin BouncingSphere = Model(
    ...
    )
end

@time bouncingSphere = @instantiateModel(...)
@time simulate!(bouncingSphere,...)
@time plot(bouncingSphere, ...)
end</code></pre><p>This gives the following output:</p><pre><code class="language-julia hljs">  0.000116 seconds (199 allocations: 12.344 KiB)

Instantiating model Main.BouncingSphereSimulation.buildModia3D(BouncingSphere)
  1.106054 seconds (2.40 M allocations: 150.386 MiB, 3.92% gc time, 62.47% compilation time)
  0.322050 seconds (579.29 k allocations: 32.774 MiB, 5.81% compilation time)
  0.077613 seconds (1.74 k allocations: 97.844 KiB)</code></pre><p>The second line</p><pre><code class="nohighlight hljs">  1.106054 seconds (2.40 M allocations: 150.386 MiB, 3.92% gc time, 62.47% compilation time)</code></pre><p>means the following:</p><ul><li>The total time spent in this statement was 1.106054 seconds<ul><li>62.47% of this time was used to compile Julia code.</li><li>3.92% of this time was used by the <em>garbage collector</em>, so was used to find and remove allocated memory that is no longer in use.</li></ul></li></ul><ul><li>There have been 2.5 million allocations of memory. In total 150.386 Mega-Bytes have been allocated.</li></ul><p>If a @time output contains <em>gc time</em> and/or <em>compilation time</em>  it might be useful to just re-run the file, in order that the total time better reflects the execution time. In a second run <em>compilation time</em> should no longer be present.</p><p>Modia3D must allocate memory at the beginning of a <code>simulate!(..)</code> run for its internal data structure. After initialization, no memory should be allocated. However, with the <code>@time</code> macro it is not possible to figure out whether this is the case. Use instead option <code>logTiming=true</code>, see next section.</p><h2 id="logTiming"><a class="docs-heading-anchor" href="#logTiming">logTiming</a><a id="logTiming-1"></a><a class="docs-heading-anchor-permalink" href="#logTiming" title="Permalink"></a></h2><p>Function <code>simulate!(..., logTiming=true, ...)</code> has keyword argument <code>logTiming</code>. When set to true, the result of the <code>@timeit</code> macro of the <a href="https://github.com/KristofferC/TimerOutputs.jl">TimerOutputs</a> package is shown. Function <code>simulate!(..)</code> and <code>Modia3D</code> are instrumented with this timer.  Example:</p><pre><code class="language-julia hljs"># File Modia3D/test/Profiling/Mobile.jl

module MobileWithLogTiming
...
const enableVisualization = false
const tolerance = 1e-4
...
@time mobile = @instantiateModel(..., logExecution=true, ...)
...
@time simulate!(mobile, ...)
@time simulate!(mobile, log=true, logTiming=true, ...)
end</code></pre><p>The <code>@time</code> macro should be used for <code>@instantiateModel</code> and <code>simulate!</code> in order to get information, whether allocation of storage is due to compilation and/or garbage collection. If the second <code>simulate!(..)</code> shows such allocation, the profiling run should be repeated.</p><p><code>@instantiateModel</code> should have flag <code>logExecution=true</code>, in order that the generated function <code>getDerivatives!(..)</code> is called twice to force compilation of this function.</p><p>The <code>logTiming=true</code> flag generates the following output in this case:</p><pre><code class="nohighlight hljs">Instantiating model Main.MobileWithLogTiming.buildModia3D(Mobile)

Execute getDerivatives
First executions of getDerivatives
  1.363270 seconds (548.47 k allocations: 45.652 MiB, 2.47% gc time, 99.56% compilation time)
  0.002773 seconds (18.82 k allocations: 1.157 MiB)
  2.540190 seconds (7.17 M allocations: 264.371 MiB, 2.62% gc time, 53.43% compilation time)
... first simulation:
  8.341341 seconds (37.34 M allocations: 2.236 GiB, 3.36% gc time)
... second simulation:
... Simulate model buildModia3D(Mobile)
      Initialization at time = 0.0 s
      Termination of buildModia3D(Mobile) at time = 5.0 s
        cpuTime         = 11.7 s
        allocated       = 2290.0 MiB
        algorithm       = CVODE_BDF
        FloatType       = Float64
        interval        = 0.01 s
        tolerance       = 0.0001 (relative tolerance)
        nStates         = 188
        nResults        = 501
        nGetDerivatives = 1968 (total number of getDerivatives! calls)
        nf              = 1465 (number of getDerivatives! calls from integrator)
        nZeroCrossings  = 0 (number of getDerivatives! calls for zero crossing detection)
        nJac            = 6 (number of Jacobian computations)
        nAcceptedSteps  = 281
        nRejectedSteps  = 3
        nErrTestFails   = 3
        nTimeEvents     = 0
        nStateEvents    = 0
        nRestartEvents  = 0

... Timings for simulation of buildModia3D(Mobile):
 ──────────────────────────────────────────────────────────────────────────────────────────────
                                                       Time                   Allocations
                                               ──────────────────────   ───────────────────────
               Tot / % measured:                    11.8s / 99.0%           2.24GiB / 100%

 Section                               ncalls     time   %tot     avg     alloc   %tot      avg
 ──────────────────────────────────────────────────────────────────────────────────────────────
 simulate!                                  1    11.7s   100%   11.7s   2.24GiB  100%   2.24GiB
 solve                                      1    11.7s   100%   11.7s   2.23GiB  100%   2.23GiB
 getDerivatives!                        1.97k    11.7s   100%  5.93ms   2.24GiB  100%   1.16MiB
 LinearEquationsIteration               1.97k    11.6s  99.3%  5.91ms   2.22GiB  99.4%  1.16MiB
 luA ldiv!                              1.97k    4.65s  39.7%  2.36ms   1.68MiB  0.07%     896B
 Modia3D                                 189k    3.56s  30.4%  18.8μs    905KiB  0.04%    4.90B
 Modia3D_2                               185k    2.57s  22.0%  13.9μs   5.16KiB  0.00%    0.03B
 Modia3D_2 computeForcesAndResiduals     185k    638ms  5.45%  3.45μs     0.00B  0.00%    0.00B
 Modia3D_2 computeKinematics!            185k    566ms  4.83%  3.06μs     0.00B  0.00%    0.00B
 Modia3D_1                              1.97k   50.3ms  0.43%  25.6μs   5.16KiB  0.00%    2.68B
 Modia3D_1 computeKinematics!           1.97k   22.4ms  0.19%  11.4μs     0.00B  0.00%    0.00B
 init!                                      1   9.46ms  0.08%  9.46ms   2.03MiB  0.09%  2.03MiB
 Modia3D_1 computeForcesAndResiduals    1.97k   8.00ms  0.07%  4.07μs     0.00B  0.00%    0.00B
 Modia3D_3                              1.97k    584μs  0.00%   297ns     0.00B  0.00%    0.00B
 ODEProblem                                 1   38.2μs  0.00%  38.2μs   2.58KiB  0.00%  2.58KiB
 Modia3D_4 isTerminal                       1    400ns  0.00%   400ns     0.00B  0.00%    0.00B
 ──────────────────────────────────────────────────────────────────────────────────────────────
 11.999957 seconds (37.34 M allocations: 2.237 GiB, 2.67% gc time)</code></pre><p>The meaning of the first lines</p><pre><code class="nohighlight hljs">First executions of getDerivatives
  1.363270 seconds (548.47 k allocations: 45.652 MiB, 2.47% gc time, 99.56% compilation time)
  0.002773 seconds (18.82 k allocations: 1.157 MiB)
  2.540190 seconds (7.17 M allocations: 264.371 MiB, 2.62% gc time, 53.43% compilation time)</code></pre><p>is the following:</p><ol><li><code>1.363270 seconds</code> is the time for the first evaluation of <code>getDerivatives!</code>. This time is nearly completely used for compilation of this function</li><li><code>0.002773 seconds</code> is the time for the second evaluation of <code>getDerivatives!</code>. This time is nearly irrelevant for the timing of <code>@instantiateModel.</code></li><li><code>2.540190</code> seconds is the total time spent in <code>@instantiateModel</code>, including the two calls of <code>getDerivatives!</code>. This time, together with (1.) shows the following:<ul><li><code>0.47*2.5 = 1.1</code> seconds are used to process the model, generate <code>getDerivatives!</code> and process <code>getDerivatives!</code> twice.</li><li><code>0.53*2.5 = 1.32</code> seconds are used to compile <code>getDerivatives!</code>.</li></ul></li></ol><p>The meaning of column <code>Section</code> is the following:</p><h4 id="@timeit-instrumentation-of-simulate!(..)"><a class="docs-heading-anchor" href="#@timeit-instrumentation-of-simulate!(..)">@timeit instrumentation of simulate!(..)</a><a id="@timeit-instrumentation-of-simulate!(..)-1"></a><a class="docs-heading-anchor-permalink" href="#@timeit-instrumentation-of-simulate!(..)" title="Permalink"></a></h4><table><tr><th style="text-align: left">Column Section</th><th style="text-align: left">Description</th></tr><tr><td style="text-align: left"><code>simulate!</code></td><td style="text-align: left">Time of <code>simulate!(..)</code>, but without log outputs.</td></tr><tr><td style="text-align: left"><code>init!</code></td><td style="text-align: left">Time of <code>init!(..)</code>, so model initialization.</td></tr><tr><td style="text-align: left"><code>ODEProblem</code></td><td style="text-align: left">Time of <code>DifferentialEquations.ODEProblem(..)</code>, so setup of problem.</td></tr><tr><td style="text-align: left"><code>solve</code></td><td style="text-align: left">Time of <code>DifferentialEquations.solve(..)</code>, so after <code>init!(..)</code>.</td></tr><tr><td style="text-align: left"><code>getDerivatives!</code></td><td style="text-align: left">Time of <code>getDerivatives!(..)</code>.</td></tr><tr><td style="text-align: left"><code>LinearEquationsIteration</code></td><td style="text-align: left">Time to build and solve linear equation systems inside <code>getDerivatives!(..)</code></td></tr><tr><td style="text-align: left"><code>luA ldiv!</code></td><td style="text-align: left">Time to solve <code>A*x=b</code> with <code>luA</code> and <code>ldiv!</code> inside <code>LinearEquationsIteration</code></td></tr></table><h4 id="@timeit-instrumentation-of-Modia3D"><a class="docs-heading-anchor" href="#@timeit-instrumentation-of-Modia3D">@timeit instrumentation of Modia3D</a><a id="@timeit-instrumentation-of-Modia3D-1"></a><a class="docs-heading-anchor-permalink" href="#@timeit-instrumentation-of-Modia3D" title="Permalink"></a></h4><table><tr><th style="text-align: left">Column Section</th><th style="text-align: left">Description</th></tr><tr><td style="text-align: left"><code>Modia3D</code></td><td style="text-align: left">Total time spent in Modia3D functions.</td></tr><tr><td style="text-align: left"><code>Modia3D_0 initializeVisualization</code></td><td style="text-align: left">Time to initialize visualization (during init!(..)).</td></tr><tr><td style="text-align: left"><code>Modia3D_1</code></td><td style="text-align: left">Time of <code>leq_mode == 0</code> (= compute h(q,qd,gravity)).</td></tr><tr><td style="text-align: left"><code>Modia3D_1 computeKinematics!</code></td><td style="text-align: left">Time to compute position, velocity, acceleration with qdd=0.</td></tr><tr><td style="text-align: left"><code>Modia3D_1 selectContactPairsWithEvent!</code></td><td style="text-align: left">Time to call <code>selectContactPairsWithEvent!</code> (collision handling).</td></tr><tr><td style="text-align: left"><code>Modia3D_1 selectContactPairsNoEvent!</code></td><td style="text-align: left">Time to call <code>selectContactPairsNoEvent!</code> (collision handling).</td></tr><tr><td style="text-align: left"><code>Modia3D_1 getDistances!</code></td><td style="text-align: left">Time to call <code>getDistances!</code> (collision handling).</td></tr><tr><td style="text-align: left"><code>Modia3D_1 dealWithContacts!</code></td><td style="text-align: left">Time to call <code>dealWithContacts!</code> (collision handling).</td></tr><tr><td style="text-align: left"><code>Modia3D_1 computeForcesAndResiduals</code></td><td style="text-align: left">Time to compute forces/torques/residuals (without collision).</td></tr><tr><td style="text-align: left"><code>Modia3D_2</code></td><td style="text-align: left">Time of <code>leq_mode &gt; 0</code> (= compute M(q)*qdd, for unit vectors of qdd).</td></tr><tr><td style="text-align: left"><code>Modia3D_2 computeKinematics!</code></td><td style="text-align: left">Time to compute accelerations with qdd = unit vector.</td></tr><tr><td style="text-align: left"><code>Modia3D_2 computeForcesAndResiduals</code></td><td style="text-align: left">Time to compute forces/torques/residuals for M(q)*qdd.</td></tr><tr><td style="text-align: left"><code>Modia3D_3</code></td><td style="text-align: left">Time of <code>leq_mode == -1</code>.</td></tr><tr><td style="text-align: left"><code>Modia3D_3 visualize!</code></td><td style="text-align: left">Time of <code>for obj in updateVisuElements ... visualize(..)</code>.</td></tr><tr><td style="text-align: left"><code>Modia3D_3 exportAnimation</code></td><td style="text-align: left">Time of <code>for obj in allVisuElements ... push!(objectData, dat)</code></td></tr><tr><td style="text-align: left"><code>Modia3D_4 isTerminal</code></td><td style="text-align: left">Time of <code>exportAnimation</code> and <code>closeVisualization</code> during termination.</td></tr></table><h4 id="How-to-instrument-with-@timeit"><a class="docs-heading-anchor" href="#How-to-instrument-with-@timeit">How to instrument with @timeit</a><a id="How-to-instrument-with-@timeit-1"></a><a class="docs-heading-anchor-permalink" href="#How-to-instrument-with-@timeit" title="Permalink"></a></h4><p>Further functions in Modia3D can be instrumented in the following way:</p><p>The timer of <a href="https://github.com/KristofferC/TimerOutputs.jl">TimerOutputs</a> is available as <code>instantiatedModel.timer</code>. Therefore, instrumenting a function call is done with:</p><pre><code class="language-julia hljs">TimerOutputs.@timeit instantiatedModel.timer &quot;Modia3D XXX&quot; functionCall(...)</code></pre><p>or</p><pre><code class="language-julia hljs">TimerOutputs.@timeit instantiatedModel.timer &quot;Modia3D XXX&quot; begin
   statements
end</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../Components/ForceElements.html">« Force Elements</a><a class="docs-footer-nextpage" href="DynamicDispatch.html">Dynamic Dispatch »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.10 on <span class="colophon-date" title="Thursday 25 November 2021 07:14">Thursday 25 November 2021</span>. Using Julia version 1.6.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
